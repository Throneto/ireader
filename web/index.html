<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ireadervalar · 在线EPUB阅读器</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <style>
      :root {
        --bg: #ffffff;
        --fg: #111111;
        --accent: #2563eb;
        --muted: #666666;
        --panel: #f6f7f9;
      }
      [data-theme="dark"] {
        --bg: #0b0f18;
        --fg: #e5e7eb;
        --accent: #60a5fa;
        --muted: #9aa4b2;
        --panel: #111827;
      }
      html, body { height: 100%; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      }
      .app {
        display: grid;
        grid-template-rows: auto 1fr;
        height: 100%;
      }
      header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-bottom: 1px solid #e5e7eb33;
        background: var(--panel);
      }
      header .brand { font-weight: 600; letter-spacing: .2px; }
      header .spacer { flex: 1; }
      header .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      header input[type="file"] { max-width: 220px; }
      header input[type="url"] { width: 260px; max-width: 40vw; padding: 6px 8px; border-radius: 6px; border: 1px solid #e5e7eb44; background: #ffffff10; color: inherit; }
      header select, header button, header input[type="range"] { padding: 6px 8px; border-radius: 6px; border: 1px solid #e5e7eb44; background: #ffffff10; color: inherit; }
      header button { cursor: pointer; }
      header button.primary { background: var(--accent); color: white; border-color: transparent; }
      header label { color: var(--muted); }

      .layout { display: grid; grid-template-columns: 280px 1fr; min-height: 0; }
      .sidebar { border-right: 1px solid #e5e7eb33; background: var(--panel); min-height: 0; display: flex; flex-direction: column; }
      .sidebar h3 { margin: 12px; font-size: 13px; color: var(--muted); }
      .sidebar .toc { flex: 1; overflow: auto; padding: 8px; }
      .sidebar .toc a { display: block; padding: 6px 8px; border-radius: 6px; color: inherit; text-decoration: none; }
      .sidebar .toc a:hover { background: #ffffff1a; }
      .sidebar .meta { border-top: 1px solid #e5e7eb33; padding: 10px 12px; font-size: 12px; color: var(--muted); }

      #viewer { position: relative; min-height: 0; }
      #reader { width: 100%; height: calc(100vh - 60px); }
      .footer {
        position: absolute; bottom: 10px; left: 10px; right: 10px;
        display: flex; gap: 10px; align-items: center;
        background: #00000020; backdrop-filter: blur(6px);
        border-radius: 8px; padding: 8px 10px; color: white;
      }
      .footer .progress { flex: 1; height: 6px; border-radius: 999px; background: #ffffff55; overflow: hidden; }
      .footer .progress > div { height: 100%; background: var(--accent); width: 0%; }
      .footer .loc { font-size: 12px; white-space: nowrap; }
      .footer button { padding: 6px 8px; border-radius: 6px; border: 0; cursor: pointer; }
      .footer button.nav { background: #00000050; color: white; }
    </style>
  </head>
  <body>
    <div class="app" id="app" data-theme="light">
      <header>
        <div class="brand">ireadervalar</div>
        <div class="controls">
          <input id="file-input" type="file" accept=".epub" />
          <input id="url-input" type="url" placeholder="输入EPUB地址" />
          <button id="open-url" class="primary">打开</button>
          <button id="prev">上一页</button>
          <button id="next">下一页</button>
          <label for="font-size">字体</label>
          <input id="font-size" type="range" min="80" max="180" value="100" />
          <label for="theme">主题</label>
          <select id="theme">
            <option value="light">浅色</option>
            <option value="dark">深色</option>
            <option value="sepia">羊皮纸</option>
          </select>
          <label for="spread">排版</label>
          <select id="spread">
            <option value="none">单页</option>
            <option value="auto" selected>自动</option>
          </select>
        </div>
        <div class="spacer"></div>
      </header>

      <div class="layout">
        <aside class="sidebar">
          <h3>目录</h3>
          <div class="toc" id="toc"></div>
          <div class="meta" id="meta">未加载书籍</div>
        </aside>
        <main id="viewer">
          <div id="reader"></div>
          <div class="footer" id="footer" hidden>
            <button class="nav" id="prev2">上一页</button>
            <button class="nav" id="next2">下一页</button>
            <div class="progress"><div id="progress-bar"></div></div>
            <div class="loc" id="loc-info">0%</div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
    <script>
      const appEl = document.getElementById('app');
      const fileInput = document.getElementById('file-input');
      const urlInput = document.getElementById('url-input');
      const openUrlBtn = document.getElementById('open-url');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');
      const prevBtn2 = document.getElementById('prev2');
      const nextBtn2 = document.getElementById('next2');
      const fontSize = document.getElementById('font-size');
      const themeSel = document.getElementById('theme');
      const spreadSel = document.getElementById('spread');
      const tocEl = document.getElementById('toc');
      const metaEl = document.getElementById('meta');
      const footerEl = document.getElementById('footer');
      const progressBar = document.getElementById('progress-bar');
      const locInfo = document.getElementById('loc-info');

      let book = null;
      let rendition = null;
      let blobUrl = null;
      let locationsReady = false;

      function reset() {
        if (rendition) { try { rendition.destroy(); } catch (e) {} rendition = null; }
        if (book) { try { book.destroy(); } catch (e) {} book = null; }
        if (blobUrl) { URL.revokeObjectURL(blobUrl); blobUrl = null; }
        tocEl.innerHTML = '';
        metaEl.textContent = '未加载书籍';
        footerEl.hidden = true;
        progressBar.style.width = '0%';
        locInfo.textContent = '0%';
        locationsReady = false;
      }

      function initThemes() {
        if (!rendition) return;
        rendition.themes.register('light', { 'body': { 'background': '#ffffff', 'color': '#111111' } });
        rendition.themes.register('dark', { 'body': { 'background': '#0b0f18', 'color': '#e5e7eb' } });
        rendition.themes.register('sepia', { 'body': { 'background': '#f4ecd8', 'color': '#5b4636' } });
        rendition.themes.select(themeSel.value);
        rendition.themes.fontSize(fontSize.value + '%');
      }

      function updateSpread() {
        if (!rendition) return;
        const spread = spreadSel.value;
        rendition.spread(spread);
      }

      function updateProgress(loc) {
        if (!book || !locationsReady) return;
        const cfi = loc && loc.start ? loc.start.cfi : rendition && rendition.location && rendition.location.start ? rendition.location.start.cfi : null;
        if (!cfi) return;
        try {
          const pct = Math.round(book.locations.percentageFromCfi(cfi) * 100);
          progressBar.style.width = pct + '%';
          locInfo.textContent = pct + '%';
        } catch (e) { }
      }

      async function loadBook(source) {
        reset();
        try {
          if (source instanceof File) {
            book = ePub();
            const buffer = await source.arrayBuffer();
            await book.open(buffer);
          } else {
            book = ePub(source);
          }
        } catch (e) {
          alert('加载书籍失败：' + e.message);
          return;
        }
        rendition = book.renderTo('reader', { width: '100%', height: '100%', spread: spreadSel.value });
        initThemes();
        await rendition.display();
        footerEl.hidden = false;

        try {
          const nav = await book.loaded.navigation;
          tocEl.innerHTML = '';
          nav.toc.forEach(item => {
            const a = document.createElement('a');
            a.textContent = item.label;
            a.href = '#';
            a.onclick = (ev) => { ev.preventDefault(); rendition.display(item.href); };
            tocEl.appendChild(a);
          });
        } catch (e) {
          tocEl.textContent = '未找到目录';
        }

        try {
          const meta = await book.loaded.metadata;
          metaEl.textContent = `${meta.title || '未知标题'} · ${meta.creator || '未知作者'}`;
        } catch (e) { metaEl.textContent = '未知书籍'; }

        try {
          await book.ready;
          await book.locations.generate(1600);
          locationsReady = true;
          updateProgress(rendition.location);
        } catch (e) { }

        rendition.on('relocated', updateProgress);
      }

      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        await loadBook(file);
      });

      openUrlBtn.addEventListener('click', async () => {
        const url = urlInput.value.trim();
        if (!url) return;
        await loadBook(url);
      });

      prevBtn.addEventListener('click', () => rendition && rendition.prev());
      nextBtn.addEventListener('click', () => rendition && rendition.next());
      prevBtn2.addEventListener('click', () => rendition && rendition.prev());
      nextBtn2.addEventListener('click', () => rendition && rendition.next());
      themeSel.addEventListener('change', (e) => { appEl.setAttribute('data-theme', e.target.value === 'dark' ? 'dark' : 'light'); rendition && rendition.themes.select(e.target.value); });
      fontSize.addEventListener('input', (e) => rendition && rendition.themes.fontSize(e.target.value + '%'));
      spreadSel.addEventListener('change', updateSpread);

      window.addEventListener('keydown', (e) => {
        if (!rendition) return;
        if (e.key === 'ArrowRight') { rendition.next(); }
        if (e.key === 'ArrowLeft') { rendition.prev(); }
      });
    </script>
  </body>
</html>